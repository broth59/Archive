# 그룹 마스터 예약 취소


1. `예약마스터 상태 수정`

```sql
 MERGE 
INTO
    TB_IR_RSVN_MST_CNXL A   USING (   SELECT
         '20346611' /**P*/ RSVN_NO /* N 예약 번호 */   ,
         '20200718' /**P*/ CNCL_DATE /* N 취소 일자 */   ,
        TO_CHAR(SYSDATE,
        'HH24MISS') CNCL_TIME /* Y 취소 시간 */   ,
         '123' /**P*/ REQ_PRSN_NAME /* Y 요청자 명 */   ,
         '' /**P*/ REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
         'TDC' /**P*/ CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
         '' /**P*/ BANK_NAME /* Y 은행 명 */   ,
         '' /**P*/ ACCT_NUM_NO /* Y 계좌 번호 */   ,
         '' /**P*/ BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
         '0' /**P*/ REFUND_AMT /* N 환불 금액 */   ,
         '' /**P*/ COMT /* Y 코멘트 */   ,
        SUBSTR( '20346611' /**P*/,
        3,
        6) RSVN_CANCEL_NO   ,
         'broth59' /**P*/ SS_USER_ID /* Y 최초 등록자 ID */   ,
         '1.1.1.1' /**P*/ SS_REMOTEIP /* N 최초 등록자 IP */   
    FROM
        DUAL   ) B   
        ON (
            A.RSVN_NO = B.RSVN_NO
        )   
        WHEN MATCHED THEN UPDATE
            
    SET
        A.CNCL_DATE = B.CNCL_DATE,
        A.CNCL_TIME = B.CNCL_TIME,
        A.REQ_PRSN_NAME = B.REQ_PRSN_NAME,
        A.REQ_PRSN_TELNO = B.REQ_PRSN_TELNO,
        A.CNCL_REASON_CODE = B.CNCL_REASON_CODE,
        A.BANK_NAME = B.BANK_NAME,
        A.ACCT_NUM_NO = B.ACCT_NUM_NO,
        A.BANK_ACCTPRSN_NAME = B.BANK_ACCTPRSN_NAME,
        A.REFUND_AMT = NVL(B.REFUND_AMT,
        0),
        A.COMT = B.COMT,
        A.RSVN_CANCEL_NO = B.RSVN_CANCEL_NO,
        A.LAST_UPD_DT = SYSDATE,
        A.LAST_UPD_USER_ID = B.SS_USER_ID,
        A.LAST_UPD_USER_IP = B.SS_REMOTEIP    
        WHEN NOT MATCHED THEN INSERT (   RSVN_NO
            /* *N 예약 번호 */   ,
            CNCL_DATE /* *N 취소 일자 */   ,
            CNCL_TIME /* Y 취소 시간 */   ,
            REQ_PRSN_NAME /* Y 요청자 명 */   ,
            REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
            CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
            BANK_NAME /* Y 은행 명 */   ,
            ACCT_NUM_NO /* Y 계좌 번호 */   ,
            BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
            REFUND_AMT /* *N 환불 금액 */   ,
            COMT /* Y 코멘트 */   ,
            RSVN_CANCEL_NO /* N Cancel No */   ,
            FIRST_REG_DT /* *N 최초 등록 일시 */   ,
            FIRST_REG_USER_ID /* Y 최초 등록자 ID */   ,
            FIRST_REG_USER_IP /* *N 최초 등록자 IP */   ,
            LAST_UPD_DT /* *N 최종 수정 일시 */   ,
            LAST_UPD_USER_ID /* Y 최종 수정자 ID */   ,
            LAST_UPD_USER_IP /* *N 최종 수정자 IP */    ) 
        VALUES
            (   B.RSVN_NO /* *N 예약 번호 */   ,
            B.CNCL_DATE /* *N 취소 일자 */   ,
            B.CNCL_TIME /* Y 취소 시간 */   ,
            B.REQ_PRSN_NAME /* Y 요청자 명 */   ,
            B.REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
            B.CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
            B.BANK_NAME /* Y 은행 명 */   ,
            B.ACCT_NUM_NO /* Y 계좌 번호 */   ,
            B.BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
            NVL(B.REFUND_AMT,
            0) /* *N 환불 금액 */   ,
            B.COMT /* Y 코멘트 */   ,
            B.RSVN_CANCEL_NO   ,
            SYSDATE /* *N 최초 등록 일시 */   ,
            B.SS_USER_ID /* Y 최초 등록자 ID */   ,
            B.SS_REMOTEIP /* *N 최초 등록자 IP */   ,
            SYSDATE /* *N 최종 수정 일시 */   ,
            B.SS_USER_ID /* Y 최종 수정자 ID */   ,
            B.SS_REMOTEIP /* *N 최종 수정자 IP */   )  
```


2. `Update Master Rsvn Status => RC`

```java
    ir00Service.updateMasterRsvnStatusForCancel(commandMap);
```

```sql
UPDATE
        TB_IR_RSVN_MST      
    SET
        RSVN_STATUS_CODE  =  'RC' /**P*/           ,
        LOCK_NO    =  433 /**P*/        ,
        LAST_UPD_DT   = SYSDATE       ,
        LAST_UPD_USER_ID    =  'broth59' /**P*/       ,
        LAST_UPD_USER_IP    =  '1.1.1.1' /**P*/     
    WHERE
        RSVN_NO     =  '20346611' /**P*/       
        AND RSVN_STATUS_CODE  IN(
            'RR', 'RW'
        )   

```


3. `디테일 멤버 취소처리`

    1. `Insert Cancelled Detail Data`

        ```java
        dao.insert("ir01_0119_insertRsvnDtlCancel", temp);
        ```
        ```sql
        MERGE 
        INTO
            TB_IR_RSVN_DTL_CNXL A   USING (   SELECT
                '20346611' /**P*/ RSVN_NO /* N 예약 번호 */   ,
                1 /**P*/ RSVN_SEQ_NO /* *N RESERVATION SEQUENCE NO(예약 순번) */   ,
                '20200718' /**P*/ CNCL_DATE /* N 취소 일자 */   ,
                null /**P*/ CNCL_TIME /* Y 취소 시간 */   ,
                '123' /**P*/ REQ_PRSN_NAME /* Y 요청자 명 */   ,
                '' /**P*/ REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
                'TDC' /**P*/ CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
                '' /**P*/ BANK_NAME /* Y 은행 명 */   ,
                '' /**P*/ ACCT_NUM_NO /* Y 계좌 번호 */   ,
                '' /**P*/ BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
                '0' /**P*/ REFUND_AMT /* N 환불 금액 */   ,
                '' /**P*/ COMT /* Y 코멘트 */   ,
                'broth59' /**P*/ SS_USER_ID /* Y 최초 등록자 ID */   ,
                '1.1.1.1' /**P*/ SS_REMOTEIP /* N 최초 등록자 IP */   
            FROM
                DUAL   ) B   
                ON (
                    A.RSVN_NO = B.RSVN_NO 
                    AND A.RSVN_SEQ_NO = B.RSVN_SEQ_NO
                )   
                WHEN MATCHED THEN UPDATE
                    
            SET
                A.CNCL_DATE = B.CNCL_DATE,
                A.CNCL_TIME = B.CNCL_TIME,
                A.REQ_PRSN_NAME = B.REQ_PRSN_NAME,
                A.REQ_PRSN_TELNO = B.REQ_PRSN_TELNO,
                A.CNCL_REASON_CODE = B.CNCL_REASON_CODE,
                A.BANK_NAME = B.BANK_NAME,
                A.ACCT_NUM_NO = B.ACCT_NUM_NO,
                A.BANK_ACCTPRSN_NAME = B.BANK_ACCTPRSN_NAME,
                A.REFUND_AMT = B.REFUND_AMT,
                A.COMT = B.COMT,
                A.LAST_UPD_DT = SYSDATE,
                A.LAST_UPD_USER_ID = B.SS_USER_ID,
                A.LAST_UPD_USER_IP = B.SS_REMOTEIP    
                WHEN NOT MATCHED THEN INSERT (   RSVN_NO
                    /* *N 예약 번호 */   ,
                    RSVN_SEQ_NO /* *N RESERVATION SEQUENCE NO(예약 순번) */   ,
                    CNCL_DATE /* *N 취소 일자 */   ,
                    CNCL_TIME /* Y 취소 시간 */   ,
                    REQ_PRSN_NAME /* Y 요청자 명 */   ,
                    REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
                    CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
                    BANK_NAME /* Y 은행 명 */   ,
                    ACCT_NUM_NO /* Y 계좌 번호 */   ,
                    BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
                    REFUND_AMT /* *N 환불 금액 */   ,
                    COMT /* Y 코멘트 */   ,
                    FIRST_REG_DT /* *N 최초 등록 일시 */   ,
                    FIRST_REG_USER_ID /* Y 최초 등록자 ID */   ,
                    FIRST_REG_USER_IP /* *N 최초 등록자 IP */   ,
                    LAST_UPD_DT /* *N 최종 수정 일시 */   ,
                    LAST_UPD_USER_ID /* Y 최종 수정자 ID */   ,
                    LAST_UPD_USER_IP /* *N 최종 수정자 IP */    ) 
                VALUES
                    (   B.RSVN_NO /* *N 예약 번호 */   ,
                    B.RSVN_SEQ_NO /* *N RESERVATION SEQUENCE NO(예약 순번) */   ,
                    B.CNCL_DATE /* *N 취소 일자 */   ,
                    B.CNCL_TIME /* Y 취소 시간 */   ,
                    B.REQ_PRSN_NAME /* Y 요청자 명 */   ,
                    B.REQ_PRSN_TELNO /* Y 요청자 전화번호 */   ,
                    B.CNCL_REASON_CODE /* Y 취소 사유 코드 */   ,
                    B.BANK_NAME /* Y 은행 명 */   ,
                    B.ACCT_NUM_NO /* Y 계좌 번호 */   ,
                    B.BANK_ACCTPRSN_NAME /* Y 예금자 명 */   ,
                    NVL(B.REFUND_AMT,
                    0) /* *N 환불 금액 */   ,
                    B.COMT /* Y 코멘트 */   ,
                    SYSDATE /* *N 최초 등록 일시 */   ,
                    B.SS_USER_ID /* Y 최초 등록자 ID */   ,
                    B.SS_REMOTEIP /* *N 최초 등록자 IP */   ,
                    SYSDATE /* *N 최종 수정 일시 */   ,
                    B.SS_USER_ID /* Y 최종 수정자 ID */   ,
                    B.SS_REMOTEIP /* *N 최종 수정자 IP */   ) 
        ```

    2. `Update Detail Rsvn Status => RC`
       
        ```java
        ir00Service.updaterDetailRsvnStatusForCancel(map);
        ```
        ```sql            
        UPDATE
            TB_IR_RSVN_DTL      
        SET
            RSVN_STATUS_CODE  =  'RC' /**P*/           ,
            LOCK_NO    =  433 /**P*/        ,
            LAST_UPD_DT   = SYSDATE       ,
            LAST_UPD_USER_ID    =  'broth59' /**P*/       ,
            LAST_UPD_USER_IP    =  '1.1.1.1' /**P*/     
        WHERE
            RSVN_NO     =  '20346611' /**P*/       
            AND RSVN_SEQ_NO    =  1 /**P*/      
            AND RSVN_STATUS_CODE  IN (
                'RR', 'RW'
        )   
        ```
    
    3. `Delete Room Assigned`
		
        ```java
        dao.delete("ir01_0119_deleteRoomAssigned", commandMap);
        ```
        ```sql
        DELETE TB_IR_ROOM_ASSIGN   
        WHERE
            RSVN_NO =  '20346612' /**P*/   
            AND RSVN_SEQ_NO =  1 /**P*/ 
        ```

    4. `Update Conn RSVN NO To Rsvn No`

        ```java
        dao.update("ir01_0119_updateConnRsvnNo", commandMap);
        ```
        ```sql
        UPDATE
            TB_IR_RSVN_MST   
        SET
            CONN_RSVN_NO = RSVN_NO   ,
            LAST_UPD_DT = SYSDATE   ,
            LAST_UPD_USER_ID =  'broth59' /**P*/   ,
            LAST_UPD_USER_IP =  '1.1.1.1' /**P*/   
        WHERE
            CONN_RSVN_NO =  '20346612' /**P*/  
        ```